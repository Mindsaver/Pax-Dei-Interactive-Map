<!DOCTYPE html>
<html>
<head>
    <title>Interactive Map with Custom Text Markers</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-contextmenu/1.4.0/leaflet.contextmenu.min.css" />
    <style>
        #map { height: 100vh; }
        .map-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .map-overlay button {
            display: block;
            margin-bottom: 5px;
        }
        #markerFormOverlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
        }
        #markerFormOverlay label {
            display: block;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="map-overlay">
        <button onclick="shareMarkers()">Share Markers</button>
        <textarea id="importData" placeholder="Paste shared markers data here"></textarea>
        <button onclick="importMarkers()">Import Markers</button>
        <button onclick="cleanMarkers()">Clean Markers</button>
    </div>
    <div id="markerFormOverlay">
        <h3>Create Marker</h3>
        <label>
            Marker Type:
            <select id="markerType">
                <option value="house">House</option>
                <option value="ore">Ore</option>
                <option value="pin">Pin</option>
            </select>
        </label>
        <label>
            Marker Text:
            <input type="text" id="markerText" />
        </label>
        <button onclick="addMarker()">Add Marker</button>
        <button onclick="closeMarkerForm()">Cancel</button>
    </div>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-contextmenu/1.4.0/leaflet.contextmenu.min.js"></script>
    <script>
        var map = L.map('map', {
            minZoom: 0,
            maxZoom: 4,
            center: [0, 0],
            zoom: 0,
            crs: L.CRS.Simple,
            contextmenu: true,
            contextmenuWidth: 140,
            contextmenuItems: [{
                text: 'Create marker',
                callback: openMarkerForm,
                index: 0
            }]
        });

        var w = 5250, h = 7415; // Dimensions of the image
        var southWest = map.unproject([0, h], map.getMaxZoom()-1);
        var northEast = map.unproject([w, 0], map.getMaxZoom()-1);
        var bounds = new L.LatLngBounds(southWest, northEast);

        L.imageOverlay('Fullmap_web_courtesy_of_Phoenix.jpg', bounds).addTo(map);
        map.setMaxBounds(bounds);

        var houseIcon = L.icon({
            iconUrl: 'house_icon_32x32.png', // Replace with your house icon URL
            iconSize: [32, 32]
        });

        var oreIcon = L.icon({
            iconUrl: 'stone_icon_32x32.png', // Replace with your ore icon URL
            iconSize: [32, 32]
        });

        var pinIcon = L.icon({
            iconUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
            shadowSize: [41, 41]
        });

        var markers = [];
        var storedMarkers = JSON.parse(localStorage.getItem('markers')) || [];

        storedMarkers.forEach(function(markerData) {
            var icon = getIconByType(markerData.type);

            var marker = L.marker([markerData.lat, markerData.lng], {
                icon: icon,
                contextmenu: true,
                contextmenuItems: [{
                    text: 'Delete marker',
                    callback: function() {
                        deleteMarker(marker, markerData);
                    }
                }]
            }).addTo(map);

            if (markerData.text) {
                marker.bindPopup(markerData.text);
            }
            markers.push(marker);
        });

        // Function to open marker form
        function openMarkerForm(e) {
            var latlng = e.latlng;
            document.getElementById('markerFormOverlay').style.display = 'block';
            document.getElementById('markerFormOverlay').dataset.latlng = JSON.stringify(latlng);
        }

        // Function to close marker form
        function closeMarkerForm() {
            document.getElementById('markerFormOverlay').style.display = 'none';
        }

        // Function to add a marker
        function addMarker() {
            var latlng = JSON.parse(document.getElementById('markerFormOverlay').dataset.latlng);
            var type = document.getElementById('markerType').value;
            var text = document.getElementById('markerText').value;

            var icon = getIconByType(type);

            var marker = L.marker(latlng, {
                icon: icon,
                contextmenu: true,
                contextmenuItems: [{
                    text: 'Delete marker',
                    callback: function() {
                        deleteMarker(marker, { lat: latlng.lat, lng: latlng.lng, text: text, type: type });
                    }
                }]
            }).addTo(map);

            if (text) {
                marker.bindPopup(text).openPopup();
            }

            storeMarker(latlng, text, type);
            markers.push(marker);

            closeMarkerForm();
        }

        // Get icon by marker type
        function getIconByType(type) {
            if (type === 'house') {
                return houseIcon;
            } else if (type === 'ore') {
                return oreIcon;
            } else {
                return pinIcon;
            }
        }

        // Store marker function
        function storeMarker(latlng, text, type) {
            var markerData = { lat: latlng.lat, lng: latlng.lng, text: text, type: type };
            storedMarkers.push(markerData);
            localStorage.setItem('markers', JSON.stringify(storedMarkers));
        }

        // Delete marker function
        function deleteMarker(marker, markerData) {
            map.removeLayer(marker);
            var index = storedMarkers.findIndex(function(m) {
                return m.lat === markerData.lat && m.lng === markerData.lng;
            });
            if (index !== -1) {
                storedMarkers.splice(index, 1);
                localStorage.setItem('markers', JSON.stringify(storedMarkers));
            }
        }

        // Share markers function
        function shareMarkers() {
            var markersData = JSON.stringify(storedMarkers);
            var encodedData = btoa(markersData);
            var shareLink = `${window.location.href.split('?')[0]}?markers=${encodedData}`;
            prompt("Share this link to import markers:", shareLink);
        }

        // Import markers function
        function importMarkers() {
            var importData = document.getElementById('importData').value;
            var importedMarkers = JSON.parse(atob(importData));

            importedMarkers.forEach(function(markerData) {
                if (!isMarkerExist(markerData)) {
                    var icon = getIconByType(markerData.type);

                    var marker = L.marker([markerData.lat, markerData.lng], {
                        icon: icon,
                        contextmenu: true,
                        contextmenuItems: [{
                            text: 'Delete marker',
                            callback: function() {
                                deleteMarker(marker, markerData);
                            }
                        }]
                    }).addTo(map);

                    if (markerData.text) {
                        marker.bindPopup(markerData.text);
                    }
                    markers.push(marker);
                    storeMarker(markerData, markerData.text, markerData.type);
                }
            });
        }

        // Check if marker exists function
        function isMarkerExist(markerData) {
            return storedMarkers.some(function(storedMarker) {
                return storedMarker.lat === markerData.lat && storedMarker.lng === markerData.lng;
            });
        }

        // Clean markers function
        function cleanMarkers() {
            markers.forEach(function(marker) {
                map.removeLayer(marker);
            });
            markers = [];
            storedMarkers = [];
            localStorage.removeItem('markers');
        }

        // Check for shared markers in URL
        function checkForSharedMarkers() {
            var urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('markers')) {
                var sharedMarkersData = atob(urlParams.get('markers'));
                var sharedMarkers = JSON.parse(sharedMarkersData);
                importSharedMarkers(sharedMarkers);
            }
        }

        // Import shared markers from URL
        function importSharedMarkers(sharedMarkers) {
            sharedMarkers.forEach(function(markerData) {
                if (!isMarkerExist(markerData)) {
                    var icon = getIconByType(markerData.type);

                    var marker = L.marker([markerData.lat, markerData.lng], {
                        icon: icon,
                        contextmenu: true,
                        contextmenuItems: [{
                            text: 'Delete marker',
                            callback: function() {
                                deleteMarker(marker, markerData);
                            }
                        }]
                    }).addTo(map);

                    if (markerData.text) {
                        marker.bindPopup(markerData.text);
                    }
                    markers.push(marker);
                    storeMarker(markerData, markerData.text, markerData.type);
                }
            });
        }

        // Initialize
        checkForSharedMarkers();
    </script>
</body>
</html>
